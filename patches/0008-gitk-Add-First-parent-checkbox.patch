From 5a8eda3a7ec51617e097fa3e0a9513bdea46c3ed Mon Sep 17 00:00:00 2001
From: Stefan Haller <stefan@haller-berlin.de>
Date: Mon, 8 Nov 2010 10:35:34 +0100
Subject: [PATCH 08/18] gitk: Add "First parent" checkbox

Sometimes it's desirable to see what changes were introduced by a
merge commit, rather than how conflicts were resolved. This adds
a checkbox which, when turned on, makes gitk show the equivalent
of "git show --first-parent <commit>" for merge commits.

Signed-off-by: Stefan Haller <stefan@haller-berlin.de>
---
 gitk-git/gitk | 25 ++++++++++++++++++++++---
 1 file changed, 22 insertions(+), 3 deletions(-)

diff --git a/gitk-git/gitk b/gitk-git/gitk
index 6837e0df75..8d55bc20ad 100755
--- a/gitk-git/gitk
+++ b/gitk-git/gitk
@@ -2423,6 +2423,10 @@ proc makewindow {} {
         pack .bleft.mid.worddiff -side left -padx 5
     }
 
+    ${NS}::checkbutton .bleft.mid.firstparent -text [mc "First parent"] \
+	-command changefirstparent -variable firstparent
+    pack .bleft.mid.firstparent -side left -padx 5
+
     set ctext .bleft.bottom.ctext
     text $ctext -background $bgcolor -foreground $fgcolor \
         -state disabled -undo 0 -font textfont \
@@ -7361,6 +7365,7 @@ proc selectline {l isnew {desired_loc {}} {switch_to_patch 0}} {
     global targetrow targetid lastscrollrows
     global autoselect autosellen jump_to_here
     global vinlinediff
+    global firstparent
 
     unset -nocomplain pending_select
     unset -nocomplain pending_select_file
@@ -7510,7 +7515,7 @@ proc selectline {l isnew {desired_loc {}} {switch_to_patch 0}} {
         gettree $id
     } elseif {$vinlinediff($curview) == 1} {
         showinlinediff $id
-    } elseif {[llength $olds] <= 1} {
+    } elseif {[llength $olds] <= 1 || $firstparent} {
         startdiff $id
     } else {
         mergediff $id
@@ -7957,7 +7962,7 @@ proc diffcmd {ids flags} {
 proc gettreediffs {ids} {
     global treediff treepending limitdiffs vfilelimit curview
 
-    set cmd [diffcmd $ids {--no-commit-id}]
+    set cmd [diffcmd $ids {--no-commit-id -m --first-parent}]
     if {$limitdiffs && $vfilelimit($curview) ne {}} {
             set cmd [concat $cmd -- $vfilelimit($curview)]
     }
@@ -8054,12 +8059,20 @@ proc initblobdiffvars {} {
     set diffseehere -1
 }
 
+proc changefirstparent {} {
+    global treediffs
+    catch {unset treediffs}
+
+    reselectline
+}
+
 proc getblobdiffs {ids} {
     global blobdifffd diffids env
     global treediffs
     global diffcontext
     global ignorespace
     global worddiff
+    global firstparent
     global limitdiffs vfilelimit curview
     global git_version
 
@@ -8071,13 +8084,18 @@ proc getblobdiffs {ids} {
     if {[package vcompare $git_version "1.6.6"] >= 0} {
         set submodule "--submodule"
     }
-    set cmd [diffcmd $ids "-p $textconv $submodule  -C --cc --no-commit-id -U$diffcontext"]
+    set cmd [diffcmd $ids "-p $textconv $submodule  -C --no-commit-id -U$diffcontext"]
     if {$ignorespace} {
         append cmd " -w"
     }
     if {$worddiff ne [mc "Line diff"]} {
         append cmd " --word-diff=porcelain"
     }
+    if {$firstparent} {
+        append cmd " -m --first-parent"
+    } else {
+        append cmd " --cc"
+    }
     if {$limitdiffs && $vfilelimit($curview) ne {}} {
         set cmd [concat $cmd -- $vfilelimit($curview)]
     }
@@ -12448,6 +12466,7 @@ set diffcontext 3
 set mergecolors {red blue "#00ff00" purple brown "#009090" magenta "#808000" "#009000" "#ff0080" cyan "#b07070" "#70b0f0" "#70f0b0" "#f0b070" "#ff70b0"}
 set ignorespace 0
 set worddiff ""
+set firstparent 0
 set markbgcolor "#e0e0ff"
 
 set headbgcolor "#00ff00"
-- 
2.30.0.100.gf7cae41892

